<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Курс: Знакомство с ИИ</title>
  <style>
    :root { --b:#dbe3ff; --bg:#f6f8ff; --btn:#2563eb; --mut:#667085; }
    body{font-family:system-ui,Segoe UI,Arial; margin:20px; background:var(--bg);}
    h1{font-size:28px; margin:0 0 14px;}
    .wrap{max-width:820px;}
    .card{background:#fff;border:1px solid var(--b);border-radius:14px;padding:14px;margin:10px 0;}
    .row{display:flex; justify-content:space-between; gap:12px; align-items:center;}
    .title{font-weight:700;}
    .tag{font-size:12px;color:var(--mut); margin-top:4px;}
    .lock{opacity:.55}
    button{border:1px solid var(--b);border-radius:999px;padding:8px 12px;background:var(--btn);color:#fff;cursor:pointer}
    button[disabled]{background:#9aa7d8;cursor:not-allowed}
    input{padding:10px;border:1px solid var(--b);border-radius:10px;width:260px}
    input:disabled{background:#eef2ff;color:#7a86b8}
    .error{color:#b42318}
    .ok{color:#027a48}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px}
    .small{font-size:12px;color:var(--mut)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .hint{font-size:12px;color:var(--mut);margin-top:8px}
    .btn-secondary{background:#eef2ff;color:#1f2a44}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>Знакомство с ИИ — уроки</h1>
      <div class="small">Курс: <span class="mono">intro-ai</span></div>
    </div>

    <div id="status" class="small">Подключение...</div>
    <div id="lessons"></div>

    <div class="card" id="codeBox" style="display:none;">
      <div class="tag">Для закрытых уроков нужен код доступа (после 3-го урока)</div>
      <div class="row" style="justify-content:flex-start;">
        <input id="codeInput" placeholder="Введите код" disabled />
        <button id="codeBtn">Активировать</button>
        <button id="logoutBtn" class="btn-secondary" style="display:none;">Выйти</button>
      </div>
      <div id="codeMsg" class="tag"></div>
      <div class="hint" id="userHint"></div>
    </div>

    <div class="card" id="debugBox" style="display:none;">
      <div class="tag"><b>Ошибка</b> (скопируйте и пришлите)</div>
      <pre id="debug" class="mono" style="white-space:pre-wrap;margin:8px 0 0;"></pre>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getFirestore, collection, getDocs, query, orderBy, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  // ===== FIREBASE CONFIG =====
  const firebaseConfig = {
    apiKey: "AIzaSyA1CMBQFz_okNdQJZDafIFFdYZJoVAXBWA",
    authDomain: "ai-course-lms.firebaseapp.com",
    projectId: "ai-course-lms",
    storageBucket: "ai-course-lms.firebasestorage.app",
    messagingSenderId: "930455880760",
    appId: "1:930455880760:web:980c6188eb533b36ce52cd"
  };

  const courseId = "intro-ai";

  // Вставьте сюда ВАШ актуальный /exec после Deploy -> New version
  const MAIL_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwMOcOe1AJ4G7HVnEz3IJJUaNZkBr7Bc2vLVUqtQgONVMo7blXrVoO2cUxV0rcIRv_AYQ/exec ";

  const statusEl = document.getElementById("status");
  const lessonsEl = document.getElementById("lessons");
  const codeBox = document.getElementById("codeBox");
  const codeInput = document.getElementById("codeInput");
  const codeBtn = document.getElementById("codeBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const codeMsg = document.getElementById("codeMsg");
  const userHint = document.getElementById("userHint");
  const debugBox = document.getElementById("debugBox");
  const debugEl = document.getElementById("debug");

  function showError(err) {
    debugBox.style.display = "block";
    debugEl.textContent = String(err?.message || err || "Unknown error");
    statusEl.innerHTML = `<span class="error">Ошибка: проверьте Firebase/Rules</span>`;
  }

  function lessonCard(lesson, canOpen) {
    const locked = !canOpen;
    const div = document.createElement("div");
    div.className = "card" + (locked ? " lock" : "");
    div.innerHTML = `
      <div class="row">
        <div>
          <div class="title">${lesson.title ?? ("Урок " + lesson.order)}</div>
          <div class="tag">Урок №${lesson.order ?? "?"}${lesson.requiresCode ? " · нужен код" : ""}</div>
        </div>
        <button ${locked ? "disabled" : ""}>Открыть</button>
      </div>
    `;
    div.querySelector("button").addEventListener("click", () => {
      if (!lesson.contentUrl) return;
      window.location.href = lesson.contentUrl;
    });
    return div;
  }

  // отправка без CORS-проблем (без preflight)
  async function postToMailWebApp(url, payload) {
    const body = JSON.stringify(payload);

    // основной вариант (CORS)
    try {
      const resp = await fetch(url, {
        method: "POST",
        mode: "cors",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body
      });

      if (resp.type !== "opaque" && !resp.ok) {
        const txt = await resp.text().catch(() => "");
        throw new Error("Apps Script вернул " + resp.status + (txt ? (": " + txt) : ""));
      }
      return true;
    } catch (e) {
      // fallback no-cors (без проверки ответа)
      await fetch(url, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body
      });
      return true;
    }
  }

  async function main() {
    try {
      if (!MAIL_WEBAPP_URL || MAIL_WEBAPP_URL.includes("PASTE_YOUR_EXEC_URL")) {
        statusEl.innerHTML = `<span class="error">Не задан MAIL_WEBAPP_URL. Вставьте ссылку /exec из Apps Script deployment.</span>`;
        return;
      }

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      statusEl.textContent = "Загрузка уроков...";

      const q = query(collection(db, "courses", courseId, "lessons"), orderBy("order"));
      const snap = await getDocs(q);
      const lessons = snap.docs.map(d => ({ id: d.id, ...d.data() }));

      if (!lessons.length) {
        statusEl.innerHTML = `<span class="error">Уроки не найдены: courses/${courseId}/lessons</span>`;
        return;
      }

      const hasLocked = lessons.some(l => l.requiresCode);
      codeBox.style.display = hasLocked ? "block" : "none";

      let currentUser = null;

      function render() {
        lessonsEl.innerHTML = "";
        for (const lesson of lessons) {
          const canOpen = !lesson.requiresCode;
          lessonsEl.appendChild(lessonCard(lesson, canOpen));
        }

        if (!hasLocked) return;

        codeInput.disabled = true;

        if (!currentUser) {
          logoutBtn.style.display = "none";
          userHint.innerHTML = `<span class="tag">Нажмите «Активировать», войдите через Google — письмо уйдёт на вашу почту.</span>`;
        } else {
          logoutBtn.style.display = "inline-block";
          userHint.innerHTML = `<span class="tag">Вы вошли как: <b>${currentUser.email ?? "Google user"}</b>. Нажмите «Активировать», чтобы получить письмо.</span>`;
        }
      }

      onAuthStateChanged(auth, (user) => {
        currentUser = user;
        statusEl.innerHTML = `<span class="ok">Готово.</span>`;
        render();
      });

      logoutBtn.addEventListener("click", async () => {
        try { await signOut(auth); } catch (e) {}
        codeMsg.className = "tag";
        codeMsg.textContent = "";
      });

      codeBtn.addEventListener("click", async () => {
        try {
          codeMsg.className = "tag";
          codeMsg.textContent = "";

          if (!auth.currentUser) {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);
          }

          const user = auth.currentUser;
          if (!user) {
            codeMsg.className = "tag error";
            codeMsg.textContent = "Не удалось войти через Google.";
            return;
          }

          const uid = user.uid;

          await setDoc(doc(db, "users", uid), {
            uid,
            email: user.email ?? null,
            name: user.displayName ?? null,
            role: "listener",
            provider: "google",
            createdAt: new Date()
          }, { merge: true });

          await postToMailWebApp(MAIL_WEBAPP_URL, {
            courseId,
            uid,
            studentEmail: user.email ?? "",
            studentName: user.displayName ?? ""
          });

          codeMsg.className = "tag ok";
          codeMsg.textContent = "Письмо отправлено на вашу почту. Проверьте «Входящие/Спам».";

          render();
        } catch (err) {
          codeMsg.className = "tag error";
          codeMsg.textContent = "Ошибка отправки: " + (err?.message || err);
          console.error(err);
        }
      });

      render();

    } catch (err) {
      showError(err);
    }
  }

  main();
</script>
</body>
</html>
